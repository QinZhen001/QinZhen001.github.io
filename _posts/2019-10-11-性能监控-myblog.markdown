---
layout:     post
title:      "æ€§èƒ½ç›‘æ§"
date:       2019-10-11 11:39:00
author:     "Qz"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - æ€§èƒ½
---

> â€œYeah It's on. â€

# æ­£æ–‡

[å‰ç«¯ç›‘æ§SDKå¼€å‘åˆ†äº«](https://mp.weixin.qq.com/s/1RNw1W2AgAylcd7Gindm4w)

å‰ç«¯ç›‘æ§ç³»ç»Ÿæœ€æ ¸å¿ƒçš„é¦–è¦æ˜¯æ”¶é›†å®¢æˆ·ç«¯çš„ç›¸å…³æ•°æ®ï¼š

æ€§èƒ½ç›¸å…³ï¼šé¦–å±æ€§èƒ½

é”™è¯¯ç›¸å…³ï¼šæ¥å£é”™è¯¯ï¼Œjsæ‰§è¡Œé”™è¯¯ï¼Œèµ„æºåŠ è½½é”™è¯¯ï¼ˆcssï¼Œjsï¼Œé™æ€èµ„æºï¼‰





## é¦–å±æ€§èƒ½ç›‘æ§


å…ˆæ˜ç¡®æ¦‚å¿µï¼š

* ç™½å±æ—¶é—´ï¼ˆfirst Paint Timeï¼‰â€”â€”ç”¨æˆ·ä»æ‰“å¼€é¡µé¢å¼€å§‹åˆ°é¡µé¢å¼€å§‹æœ‰ä¸œè¥¿å‘ˆç°ä¸ºæ­¢
* é¦–å±æ—¶é—´â€”â€”ç”¨æˆ·æµè§ˆå™¨é¦–å±å†…æ‰€æœ‰å†…å®¹éƒ½å‘ˆç°å‡ºæ¥æ‰€èŠ±è´¹çš„æ—¶é—´

>å…ˆè§¦å‘first paintï¼Œåè§¦å‘dom ready

>ç”¨æˆ·å¯æ“ä½œæ—¶é—´(dom Interactive)â€”â€”ç”¨æˆ·å¯ä»¥è¿›è¡Œæ­£å¸¸çš„ç‚¹å‡»ã€è¾“å…¥ç­‰æ“ä½œï¼Œé»˜è®¤å¯ä»¥ç»Ÿè®¡domreadyæ—¶é—´ï¼Œå› ä¸ºé€šå¸¸ä¼šåœ¨è¿™æ—¶å€™ç»‘å®šäº‹ä»¶æ“ä½œ



First paint time çš„æ¦‚å¿µW3Cå¹¶æ²¡æœ‰å®šä¹‰ï¼Œå› ä¸ºæ˜¯å­˜åœ¨äº‰è®®çš„ã€‚

[https://github.com/w3c/navigation-timing/issues/21](https://github.com/w3c/navigation-timing/issues/21)


---------------------

å»ºç«‹æŒ‡æ ‡

* DNSæŸ¥è¯¢æ—¶é—´  (domainLookupEnd - domainLookupStart)
* tcpè¿æ¥æ—¶é—´ (connectEnd - connectStart)
* é¦–æ¬¡requestè¯·æ±‚æ–‡æ¡£æ—¶é—´ (responseStart - requestStart)
* é¦–æ¬¡responseæ—¶é—´  (responseEnd - responseStart)
* ç™½å±æ—¶é—´ = (domLoading - navigationStart)
* DOMæ ‘è§£ææ—¶é—´  = (domComplete - domLoading)

[https://github.com/Tencent/vConsole](https://github.com/Tencent/vConsole)


>å‚è€ƒvconsole


```javascript
    // performance related
    // use `setTimeout` to make sure all timing points are available
    setTimeout(function() {
      let performance = window.performance || window.msPerformance || window.webkitPerformance;

      // timing
      if (performance && performance.timing) {
        let t = performance.timing;
        if (t.navigationStart) {
          console.info('[system]', 'navigationStart:', t.navigationStart);
        }
        if (t.navigationStart && t.domainLookupStart) {
          console.info('[system]', 'navigation:', (t.domainLookupStart - t.navigationStart)+'ms');
        }
        if (t.domainLookupEnd && t.domainLookupStart) {
          console.info('[system]', 'dns:', (t.domainLookupEnd - t.domainLookupStart)+'ms');
        }
        if (t.connectEnd && t.connectStart) {
          if (t.connectEnd && t.secureConnectionStart) {
            console.info('[system]', 'tcp (ssl):', (t.connectEnd - t.connectStart)+'ms ('+(t.connectEnd - t.secureConnectionStart)+'ms)');
          } else {
            console.info('[system]', 'tcp:', (t.connectEnd - t.connectStart)+'ms');
          }
        }
        if (t.responseStart && t.requestStart) {
          console.info('[system]', 'request:', (t.responseStart - t.requestStart)+'ms');
        }
        if (t.responseEnd && t.responseStart) {
          console.info('[system]', 'response:', (t.responseEnd - t.responseStart)+'ms');
        }
        if (t.domComplete && t.domLoading) {
          if (t.domContentLoadedEventStart && t.domLoading) {
            console.info('[system]', 'domComplete (domLoaded):', (t.domComplete - t.domLoading)+'ms ('+(t.domContentLoadedEventStart - t.domLoading)+'ms)');
          } else {
            console.info('[system]', 'domComplete:', (t.domComplete - t.domLoading)+'ms');
          }
        }
        if (t.loadEventEnd && t.loadEventStart) {
          console.info('[system]', 'loadEvent:', (t.loadEventEnd - t.loadEventStart)+'ms');
        }
        if (t.navigationStart && t.loadEventEnd) {
          console.info('[system]', 'total (DOM):', (t.loadEventEnd - t.navigationStart)+'ms ('+(t.domComplete - t.navigationStart)+'ms)');
        }
      }
    }, 0);
```





## ç›‘æ§æ¥å£é”™è¯¯

[https://juejin.cn/post/6862559324632252430#heading-0](https://juejin.cn/post/6862559324632252430#heading-0)





## jsè¿è¡Œé”™è¯¯

window.onerror | unhandledrejection | console.error | ä»¥åŠæ¡†æ¶è‡ªå¸¦çš„ç›‘å¬å‡½æ•°

```js
  window.addEventListener('error', function(e) {
    const { message, filename, lineno, colno, error } = e
    const route = router.currentRoute
    const page = route.meta.pv || route.name || route.path.split('/').pop()
    window.logger.log({
      event: 'error',
      page,
      url: filename,
      line: lineno,
      col: colno,
      msg: message,
      error
    })
  })
```

ç›‘å¬unhandledrejection

å½“[`Promise`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise) è¢« `reject` ä¸”æ²¡æœ‰ `reject` å¤„ç†å™¨çš„æ—¶å€™ï¼Œä¼šè§¦å‘ `unhandledrejection` äº‹ä»¶

```js
window.addEventListener('unhandledrejection', (e) => {
  console.log(e)
})
```



æ³¨æ„ï¼š

* ä¸€æ˜¯`onerror`ä¼šè·å–ä¸åˆ°è·¨åŸŸçš„`script`é”™è¯¯ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼šä¸ºè·¨åŸŸçš„`script`æ ‡ç­¾è®¾ç½®`crossorigin`å±æ€§ï¼Œå¹¶ä¸”éœ€è¦é™æ€æœåŠ¡å™¨ä¸ºå½“å‰èµ„æºè®¾ç½®`CORS`å“åº”å¤´ã€‚
* äºŒæ˜¯ä»£ç å‹ç¼©åçš„æŠ¥é”™ä¿¡æ¯éœ€è¦é€šè¿‡`sourceMap`æ–‡ä»¶è§£æå‡ºæºä»£ç å¯¹åº”çš„è¡Œåˆ—å’Œé”™è¯¯ä¿¡æ¯ï¼Œ`sourceMap`æœ¬èº«æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå­˜å‚¨äº†æºä»£ç å’Œå‹ç¼©ä»£ç çš„å…³ç³»æ•°æ®ï¼Œé€šè¿‡è§£æåº“èƒ½å¤Ÿå¾ˆè½»æ¾è½¬æ¢å®ƒä»¬ã€‚ä½†å¦‚ä½•è‡ªåŠ¨åŒ–ç®¡ç†å’Œæ“ä½œ`sourceMap`æ–‡ä»¶æ‰æ˜¯å‰ç«¯ç›‘æ§ç³»ç»Ÿæ ¸å¿ƒéœ€è¦è§£å†³çš„é—®é¢˜ã€‚è¿™é‡Œå°±éœ€è¦ç»“åˆä¼ä¸šå†…éƒ¨çš„é™æ€èµ„æºå‘å¸ƒç³»ç»Ÿå’Œå‰ç«¯ç›‘æ§ç³»ç»Ÿï¼Œæ¥è§£å†³ä½æ•ˆç‡çš„æ‰‹åŠ¨æ‰“åŒ…ä¸Šä¼ é—®é¢˜ã€‚





## å¾®ä¿¡å°ç¨‹åº

é€šè¿‡é‡å†™å®ƒçš„éƒ¨åˆ†å…¨å±€å‡½æ•°å’Œç›¸å…³`API`æˆ‘ä»¬èƒ½è·å–åˆ°ï¼šç½‘ç»œè¯·æ±‚ã€é”™è¯¯ä¿¡æ¯ã€è®¾å¤‡å’Œç‰ˆæœ¬ä¿¡æ¯ç­‰ã€‚ç”±äºå¾®ä¿¡å°ç¨‹åºçš„åŠ è½½æµç¨‹æ˜¯ç”±å¾®ä¿¡`APP`æ§åˆ¶çš„ï¼Œ`js`ç­‰èµ„æºä¹Ÿè¢«å¾®ä¿¡å†…éƒ¨æ‰˜ç®¡ï¼Œå› æ­¤å’Œ`web`ä¸åŒï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•è·å–åˆ°`web`ä¸­`performance`èƒ½è·å–åˆ°çš„é¡µé¢å’Œèµ„æºåŠ è½½ä¿¡æ¯ã€‚





### Appå’ŒComponent

é€šè¿‡é‡å†™å…¨å±€çš„`App`å‡½æ•°ï¼Œç»‘å®š`onError`æ–¹æ³•ç›‘å¬é”™è¯¯ï¼Œé‡å†™å®ƒçš„`onShow`æ–¹æ³•æ‰§è¡Œå°ç¨‹åºå¯åŠ¨æ—¶`SDK`éœ€è¦çš„é€»è¾‘ã€‚é€šè¿‡é‡å†™`Component`çš„`onShow`æ–¹æ³•ï¼Œå¯ä»¥åœ¨é¡µé¢ç»„ä»¶åˆ‡æ¢æ—¶æ‰§è¡Œæˆ‘ä»¬çš„è·¯å¾„æ”¶é›†å’Œæ‰§è¡Œä¸ŠæŠ¥ç­‰é€»è¾‘ã€‚

```tsx
// SDKåˆå§‹åŒ–å‡½æ•°
init(){
    this.appMethod = App;
    this.componentMethod = Component;
    const ctx = this;
    //é‡å†™å¾®ä¿¡å°ç¨‹åºComponent
    Component = (opts) => {
      overrideComponent(opts, ctx);
      ctx.componentMethod(opts);
    };
    //é‡å†™å¾®ä¿¡å°ç¨‹åºApp
    App = (app) => {
      overrideApp(app, ctx);
      ctx.appMethod(app);
    };
}  

//æ³¨æ„ctxæ˜¯sdkçš„this
overrideComponent(opts, ctx) => {
  const compOnShow = opts.methods.onShow;
  opts.methods.onShow = function(){
    // do something
    //æ³¨æ„è¿™é‡Œçš„thisæ˜¯å®é™…è°ƒç”¨æ–¹
    compOnShow.apply(this, arguments)
  }
})

overrideApp(app, ctx) => {
  const _onError = app.onError || function () {};
  const _onShow = app.onShow || function () {};
  app.onError = function (err) {
    reportError(err, ctx);
    return _onError.apply(this, arguments);
  };
  app.onShow = function () {
    //do something
    return _onShow.apply(this, arguments);
  };
})

```



# è¡¥å……





## replaceOld

è£…é¥°å™¨æ¨¡å¼ï¼Œå¢å¼ºåŸå‡½æ•°

![replaceOld](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9828fb478366475eb547e7f26f15f0fd~tplv-k3u1fbpfcp-zoom-1.image)



## Navigator.sendBeacon

https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon

```tsx
const blob = new Blob([JSON.stringify(formData)], { type: 'text/plain; charset=UTF-8' });
navigator.sendBeacon(`${this.baseUrl}${config.url || ''}`, blob);
```

[https://stackoverflow.com/questions/45274021/sendbeacon-api-not-working-temporarily-due-to-security-issue-any-workaround](https://stackoverflow.com/questions/45274021/sendbeacon-api-not-working-temporarily-due-to-security-issue-any-workaround)

The only allowed values for the Content-Type header in sendBeacon now are:

- application/x-www-form-urlencoded
- multipart/form-data
- text/plain

**sendBeacon ä¸æ”¯æŒapplication/json**  åº”è¯¥æ˜¯æµè§ˆå™¨çš„BUG  æ–°ä¸€ç‚¹chormeåº”è¯¥ğŸ†—  ï¼ˆæ²¡è¯•éªŒè¿‡ï¼‰